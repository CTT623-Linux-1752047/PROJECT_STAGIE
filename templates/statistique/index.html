{% extends "base/index.html" %}
{% load static %}
{% block stylesheet %}
<link rel="stylesheet" href="{% static 'vendor/select2/css/select2.min.css' %}">
<link href="{% static 'vendor/chartist/css/chartist.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="col-lg-12">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-lg-5">
                    Les techniques
                    <select class="single-select-placeholder js-states" id="searchCondition1" >
                        <option value=""></option>
                        {% for tech in lstTechniques %}
                        <option value="{{ tech.techniqueCd }}">{{ tech.techniqueName }}</option>                       
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-4">
                    Les étudiants
                    <select class="single-select-placeholder js-states" id="searchCondition2">
                        <option value=""></option>
                        {% for student in lstStudent %}
                        <option value="{{ student.studentCd }}">{{ student.fullNameStudent }}</option>                       
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-3">
                    Les groups/classe
                    <select class="single-select-placeholder js-states" id="searchCondition3">
                        <option value=""></option>
                        {% for group in lstGroup %}
                        <option value="{{ group.groupCd }}">{{ group.groupName }}</option>                       
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-12">
                    <button id ="btnSearch" type="button" class="btn btn-primary" style="float:right  ; margin-top:10px">
                        <i class="ti-search"></i>
                        &nbsp;Recherche
                    </button>
                </div>
                
            </div>            
        </div>
    </div>
    <div class="row">
        <div class="col-lg-5 col-sm-12">
            <div class="card">
                
                <div class="stat-widget-one card-body">
                    <div class="stat-icon d-inline-block" style="margin-top: 10px">
                        <i class="ti-book text-success border-success"></i>
                    </div>
                    <div class="stat-content d-inline-block" style="margin-left: 10px">
                        <div class="stat-digit" style="font-size: 20px">Technique : {{lstTechniques|length}}</div>
                        <div class="stat-text">※ La technique de concurrence mondiale : <span style="font-weight: bold; font-size: 15px">{{relationshipTech.hasGlobalConcurrency}}</span></div>
                        <div class="stat-text">※ La technique de concurrence partielle : <span style="font-weight: bold; font-size: 15px">{{relationshipTech.hasPartialConcurrency}}</span></div>
                        <div class="stat-text">※ la technique d'extension de la concurrence : <span style="font-weight: bold; font-size: 15px">{{relationshipTech.hasConcurrencyByExtension}}</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-sm-12">
            <div class="card">
                <div class="stat-widget-one card-body">
                    <div class="stat-icon d-inline-block" style="margin-top: 10px">
                        <i class="ti-user text-primary border-primary"></i>
                    </div>
                    <div class="stat-content d-inline-block" style="margin-left: 10px">     
                        <div class="stat-digit" style="font-size: 20px">Étudiants : {{lstStudent|length}}</div>
                        <div class="stat-text">※ En cours : &nbsp; <span style="font-weight: bold; font-size: 15px;">{{relationshipStudent.enCours}}</span></div>
                        <div class="stat-text">※ Acquis : &nbsp; <span style="font-weight: bold; font-size: 15px">{{relationshipStudent.Acquis}}</span></div>
                        <div class="stat-text">※ Maîtrise : &nbsp; <span style="font-weight: bold; font-size: 15px">{{relationshipStudent.Maitrise}}</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-sm-12">
            <div class="card">
                <div class="stat-widget-one card-body">
                    <div class="stat-icon d-inline-block" style="margin-top: 10px">
                        <i class="ti-layout-grid2 text-pink border-pink"></i>
                    </div>
                    <div class="stat-content d-inline-block" style="margin-left: 10px">
                        <div class="stat-digit" style="font-size: 20px">Classe : {{lstGroup|length}}</div>
                        <div class="stat-digit" style="font-size: 20px">Group : {{lstGroup|length}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-lg-12" id="areaChart">
    
</div>
{% endblock content %}
{% block afterScript %}
<script src="{% static 'vendor/select2/js/select2.full.min.js' %}"></script>
<script src="{% static 'js/plugins-init/select2-init.js' %}"></script>
<script src="{% static 'vendor/chartist/js/chartist.min.js' %}"></script>
<script src="{% static 'vendor/moment/moment.min.js' %}"></script>
<script src="{% static 'vendor/raphael/raphael.min.js' %}"></script>
<script src="{% static 'vendor/morris/morris.min.js' %}"></script>


<script type="text/javascript">

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    $(document).ready(function() {
       $("#btnSearch").click(function(){
           searchCondition1 = $("#searchCondition1").val()
           searchCondition2 = $("#searchCondition2").val()
           searchCondition3 = $("#searchCondition3").val()
         
           url = window.location.href
        
           $.ajax({
                url : url,
                type : 'POST',
                data : {
                    searchCondition1 : searchCondition1,
                    searchCondition2 : searchCondition2,
                    searchCondition3 : searchCondition3,
                    csrfmiddlewaretoken : '{{ csrf_token }}'        
                },
                success : function(response) {                      
                    if(response["response"] != false){
                        console.log(response)
                    
                        divAreaChart = $("#areaChart")
                        divAreaChart.empty()
    
                        // add bar chart html 
                        divMainBarChart = $("<div/>")
                        divMainBarChart.attr("class","ct-bar-chart mt-5")
    
                        divCardBodyBarChart = $("<div/>")
                        divCardBodyBarChart.attr("class","card-body")
                        divCardBodyBarChart.append(divMainBarChart)
    
                        divCardBarChart = $("<div/>")
                        divCardBarChart.attr("class","card")
                        divCardBarChart.append(divCardBodyBarChart)
    
                        divColBarChart = $("<div/>")
                        divColBarChart.attr("class","col-lg-9")
                        divColBarChart.append(divCardBarChart)
                        
                        // add pie chart html 
                        divMainPieChart = $("<div/>")
                        divMainPieChart.attr("id","ct-pie-chart")
    
                        divCardBodyPieChart = $("<div/>")
                        divCardBodyPieChart.attr("class","card-body")
                        divCardBodyPieChart.append(divMainPieChart)
    
                        divCardPieChart = $("<div/>")
                        divCardPieChart.attr("class","card")
                        divCardPieChart.append(divCardBodyPieChart)
    
                        divColPieChart = $("<div/>")
                        divColPieChart.attr("class","col-lg-3")
                        divColPieChart.append(divCardPieChart)
    
                        // add bar and pie chart to row 
                        divRow = $("<div/>")
                        divRow.attr("class","row")
                        divRow.append(divColBarChart)
                        divRow.append(divColPieChart)
    
                        divCardBodyParent = $("<div/>")
                        divCardBodyParent.attr("class","card-body")
                        divCardBodyParent.append(divRow)
    
                        divCardParent = $("<div/>")
                        divCardParent.attr("class","card")
                        divCardParent.append(divCardBodyParent)
                        divAreaChart.append(divCardParent)

                        //pie chart 
                        Morris.Donut({
                            element: 'ct-pie-chart',
                            data: [{
                                label: "\xa0 \xa0 En cours \xa0 \xa0",
                                value: response["response"]["pieChart"][0],
                    
                            }, {
                                label: "\xa0 \xa0 Acquis \xa0 \xa0",
                                value: response["response"]["pieChart"][1]
                            }, {
                                label: "\xa0 \xa0 Maîtrise \xa0 \xa0",
                                value: response["response"]["pieChart"][2]
                            }],
                            resize: true,
                            colors: ['#75B432', 'rgb(192, 10, 39)', '#4400eb']
                        });

                        var data = {
                            labels:  response["response"]["barChart"][1],
                            series: [
                                response["response"]["barChart"][2],
                                response["response"]["barChart"][3],
                                response["response"]["barChart"][4],
                            ]
                        };
                    
                        var options = {
                            seriesBarDistance: 10
                        };
                    
                        var responsiveOptions = [
                            ['screen and (max-width: 640px)', {
                                seriesBarDistance: 5,
                                axisX: {
                                    labelInterpolationFnc: function(value) {
                                        return value[0];
                                    }
                                }
                            }]
                        ];
                    
                        new Chartist.Bar('.ct-bar-chart', data, options, responsiveOptions);
                    }       
                    
                },
                error : function(request,error)
                {
                    alert("Request: "+JSON.stringify(request));
                }
            });
       })

    });
</script>
{% endblock afterScript%}